<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ—Ä—Å–∫–æ–π –ë–æ–π - P2P –ò–≥—Ä–∞</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #60a5fa;
        }
        
        h2 {
            font-size: 1.5rem;
            margin: 20px 0 10px;
            color: #93c5fd;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        
        .btn-copy {
            background: #10b981;
        }
        
        .btn-connect {
            background: #8b5cf6;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #374151;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            margin: 10px 0;
        }
        
        input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .status-connected {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            color: #86efac;
        }
        
        .status-disconnected {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }
        
        .id-display {
            font-family: 'Roboto Mono', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            word-break: break-all;
            margin: 10px 0;
            font-size: 14px;
        }
        
        #gameBoards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            margin-top: 10px;
        }
        
        .cell {
            aspect-ratio: 1;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cell:hover {
            background: rgba(59, 130, 246, 0.4);
        }
        
        .cell.ship {
            background: #4f46e5;
        }
        
        .cell.hit {
            background: #ef4444;
        }
        
        .cell.miss {
            background: #6b7280;
        }
        
        #messages {
            height: 200px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .message-system {
            color: #60a5fa;
            font-style: italic;
        }
        
        .message-friend {
            color: #86efac;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #9ca3af;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            #gameBoards {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öì –ú–æ—Ä—Å–∫–æ–π –ë–æ–π P2P</h1>
            <p>–ò–≥—Ä–∞–π—Ç–µ —Å –¥—Ä—É–≥–æ–º –ø–æ –ø—Ä—è–º–æ–º—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é</p>
        </header>
        
        <div class="card">
            <h2>üì° –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
            <div id="status" class="status status-disconnected">
                ‚è≥ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É...
            </div>
        </div>
        
        <div class="card">
            <h2>üéÆ –í—ã - –•–æ—Å—Ç</h2>
            <p>–í–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</p>
            <div id="yourId" class="id-display">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button class="btn btn-copy" onclick="copyId()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
            <p style="margin-top: 10px; font-size: 14px; color: #9ca3af;">
                –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç ID –¥—Ä—É–≥—É, —á—Ç–æ–±—ã –æ–Ω –º–æ–≥ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
            </p>
        </div>
        
        <div class="card">
            <h2>üë• –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –¥—Ä—É–≥—É</h2>
            <p>–ï—Å–ª–∏ –¥—Ä—É–≥ —Å–æ–∑–¥–∞–ª –∫–æ–º–Ω–∞—Ç—É, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ ID:</p>
            <input type="text" id="friendId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞">
            <button class="btn btn-connect" onclick="connectToFriend()">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
        
        <div id="gameBoards" style="display: none;">
            <div class="card">
                <h2>–í–∞—à —Ñ–ª–æ—Ç</h2>
                <div id="playerBoard" class="board"></div>
            </div>
            
            <div class="card">
                <h2>–§–ª–æ—Ç –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞</h2>
                <div id="enemyBoard" class="board"></div>
            </div>
        </div>
        
        <div class="card">
            <h2>üí¨ –õ–æ–≥ –∏–≥—Ä—ã</h2>
            <div id="messages"></div>
        </div>
        
        <footer>
            <p>–ò–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ WebRTC (Peer-to-Peer)</p>
            <p>–°–µ—Ä–≤–µ—Ä —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞: 0.peerjs.com</p>
        </footer>
    </div>

    <script>
        // ============ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ============
        const PEER_CONFIG = {
            // –ë–ï–°–ü–õ–ê–¢–ù–´–ô –°–ï–†–í–ï–† SIGNALING
            host: '0.peerjs.com',
            port: 443,
            path: '/',
            secure: true,
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        };
        
        // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ============
        let peer = null;
        let conn = null;
        let isHost = false;
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ============
        function initPeer() {
            console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PeerJS...');
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID
            const randomId = 'player_' + Math.random().toString(36).substr(2, 9);
            
            // –°–æ–∑–¥–∞–µ–º Peer
            peer = new Peer(randomId, PEER_CONFIG);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            peer.on('open', handlePeerOpen);
            peer.on('error', handlePeerError);
            peer.on('connection', handleIncomingConnection);
        }
        
        // ============ –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ============
        function handlePeerOpen(id) {
            console.log('‚úÖ Peer –æ—Ç–∫—Ä—ã—Ç. –í–∞—à ID:', id);
            document.getElementById('yourId').textContent = id;
            updateStatus('connected', '‚úÖ –ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é!');
            createGameBoards();
        }
        
        function handlePeerError(err) {
            console.error('‚ùå Peer –æ—à–∏–±–∫–∞:', err);
            
            let errorMsg = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            switch(err.type) {
                case 'network':
                    errorMsg = '–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç';
                    break;
                case 'server-error':
                    errorMsg = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...';
                    setTimeout(initPeer, 3000);
                    break;
                case 'peer-unavailable':
                    errorMsg = '–î—Ä—É–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID';
                    break;
            }
            
            updateStatus('disconnected', '‚ùå ' + errorMsg);
        }
        
        function handleIncomingConnection(connection) {
            console.log('üë• –í—Ö–æ–¥—è—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:', connection.peer);
            isHost = true;
            setupConnection(connection);
            updateStatus('connected', '‚úÖ –î—Ä—É–≥ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!');
            addMessage('system', `–ò–≥—Ä–æ–∫ ${connection.peer} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`);
        }
        
        // ============ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –î–†–£–ì–£ ============
        function connectToFriend() {
            const friendId = document.getElementById('friendId').value.trim();
            if (!friendId) {
                alert('‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞');
                return;
            }
            
            console.log('üîÑ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫:', friendId);
            updateStatus('disconnected', 'üîÑ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...');
            
            conn = peer.connect(friendId, {
                reliable: true,
                serialization: 'json'
            });
            
            setupConnection(conn);
        }
        
        function setupConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                console.log('üîó –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å:', conn.peer);
                updateStatus('connected', '‚úÖ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!');
                addMessage('system', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
                document.getElementById('gameBoards').style.display = 'grid';
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                sendGameData({
                    type: 'hello',
                    playerId: peer.id,
                    game: '–ú–æ—Ä—Å–∫–æ–π –ë–æ–π',
                    timestamp: Date.now()
                });
            });
            
            conn.on('data', handleGameData);
            conn.on('close', handleConnectionClose);
            conn.on('error', handleConnectionError);
        }
        
        // ============ –û–ë–†–ê–ë–û–¢–ö–ê –ò–ì–†–´ ============
        function handleGameData(data) {
            console.log('üì® –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
            
            switch(data.type) {
                case 'hello':
                    addMessage('friend', `–ü—Ä–∏–≤–µ—Ç –æ—Ç ${data.playerId}`);
                    // –û—Ç–≤–µ—á–∞–µ–º
                    sendGameData({
                        type: 'hello_response',
                        message: '–ü—Ä–∏–≤–µ—Ç! –ì–æ—Ç–æ–≤ –∏–≥—Ä–∞—Ç—å!'
                    });
                    break;
                    
                case 'shot':
                    handleShot(data.x, data.y);
                    break;
                    
                case 'ship_placement':
                    updateEnemyBoard(data.ships);
                    break;
                    
                default:
                    addMessage('friend', JSON.stringify(data));
            }
        }
        
        function sendGameData(data) {
            if (conn && conn.open) {
                conn.send(data);
            } else {
                console.warn('‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ');
            }
        }
        
        // ============ –ò–ì–†–û–í–û–ï –ü–û–õ–ï ============
        function createGameBoards() {
            createBoard('playerBoard', true);
            createBoard('enemyBoard', false);
        }
        
        function createBoard(boardId, isPlayerBoard) {
            const board = document.getElementById(boardId);
            board.innerHTML = '';
            
            for (let y = 0; y < 10; y++) {
                for (let x = 0; x < 10; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    if (isPlayerBoard) {
                        cell.addEventListener('click', () => placeShip(x, y));
                    } else {
                        cell.addEventListener('click', () => makeShot(x, y));
                    }
                    
                    board.appendChild(cell);
                }
            }
        }
        
        function placeShip(x, y) {
            const cell = document.querySelector(`#playerBoard .cell[data-x="${x}"][data-y="${y}"]`);
            cell.classList.toggle('ship');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –¥—Ä—É–≥—É
            sendGameData({
                type: 'ship_placement',
                x: x,
                y: y
            });
        }
        
        function makeShot(x, y) {
            if (!conn || !conn.open) {
                alert('‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –¥—Ä—É–≥—É');
                return;
            }
            
            const cell = document.querySelector(`#enemyBoard .cell[data-x="${x}"][data-y="${y}"]`);
            cell.classList.add('hit');
            
            sendGameData({
                type: 'shot',
                x: x,
                y: y,
                player: peer.id
            });
            
            addMessage('system', `–í—ã –≤—ã—Å—Ç—Ä–µ–ª–∏–ª–∏ –≤ (${x}, ${y})`);
        }
        
        function handleShot(x, y) {
            const cell = document.querySelector(`#playerBoard .cell[data-x="${x}"][data-y="${y}"]`);
            if (cell.classList.contains('ship')) {
                cell.classList.add('hit');
                addMessage('friend', `–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø–æ–ø–∞–ª –≤ (${x}, ${y})!`);
            } else {
                cell.classList.add('miss');
                addMessage('friend', `–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è –≤ (${x}, ${y})`);
            }
        }
        
        // ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
        function updateStatus(status, message) {
            const elem = document.getElementById('status');
            elem.textContent = message;
            elem.className = `status status-${status}`;
        }
        
        function addMessage(sender, text) {
            const messages = document.getElementById('messages');
            const msg = document.createElement('div');
            msg.className = `message message-${sender}`;
            msg.innerHTML = `<strong>${sender === 'system' ? '‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞' : 'üë§ –î—Ä—É–≥'}:</strong> ${text}`;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function copyId() {
            const id = document.getElementById('yourId').textContent;
            if (id && id !== '–ó–∞–≥—Ä—É–∑–∫–∞...') {
                navigator.clipboard.writeText(id).then(() => {
                    alert('‚úÖ ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä: ' + id);
                });
            }
        }
        
        function handleConnectionClose() {
            console.log('üîí –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
            updateStatus('disconnected', '‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
            document.getElementById('gameBoards').style.display = 'none';
            addMessage('system', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ');
        }
        
        function handleConnectionError(err) {
            console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', err);
            addMessage('system', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + err.message);
        }
        
        // ============ –ó–ê–ü–£–°–ö ============
        window.addEventListener('load', () => {
            initPeer();
            addMessage('system', '–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
        });
    </script>
</body>
</html>